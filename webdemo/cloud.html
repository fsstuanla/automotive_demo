<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="author" content="Ben Freke">
    <meta name="description" content="CLOUD">
    <title>CLOUD</title>
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* So it's obvious when the button colour changes */
        .btn {
            transition: all 1s;
        }
        .panel-info{
            width: 97%;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-xs-12">
            <header>
                <h1>Cloud
                    <small>Version 1.0.0</small>
                </h1>
            </header>

            <section class="Information">
                <p>Cloud Simulator:</p>
                <ul>
                    <li>Listen packets</li>
                    <li>Send packets</li>
                </ul>
            </section>

            <section class="panel panel-primary">
                <div class="panel-heading">
                    <h2 class="panel-title">Communication</h2>
                </div>
                <div class="panel-body">
                    <form>
                        <div class="row">
                            <div class="col-lg-4">
                                <input type="text" class="form-control" id="port" placeholder="Port number" value="12345">
                            </div>
                            <div class="col-lg-8">
                                <select id="xml_data" class="form-select-sm">

                                </select>
                            </div>

                        </div>
                        <div class="row">
                            <div class="col-lg-4">
                                <button id="listen" type="button" class="btn btn-primary">Listen
                                    <!--                                    <span class="toggleonclick glyphicon glyphicon-thumbs-up hidden"></span>-->
                                    <!--                                    <span class="toggleonclick">Listen</span>-->
                                    <!--                                    <span class="toggleonclick hidden">Stop</span>-->
                                </button>
                            </div>
                            <div class="col-lg-8">
                                <div class="form-group ">
                                    <button id="send" type="button" class="btn btn-primary">
                                        <span class="toggleonclick glyphicon glyphicon-thumbs-up hidden"></span>
                                        <span class="toggleonclick">Send</span>
                                        <span class="toggleonclick hidden">Sent</span>
                                    </button>
                                </div>
                            </div>

                        </div>
                    </form>

                </div>
            </section>

            <section id="group-demos" class="panel panel-primary">
                <header class="panel-heading">
                    <h3 class="panel-title">Messages</h3>
                </header>
                <article class="panel-body">
                    <div id="exTab1" class="container">
                        <ul class="nav nav-pills">
                            <li class="active">
                                <a href="#1a" data-toggle="tab">Received Messages</a>
                            </li>
                            <li><a href="#2a" data-toggle="tab">Sent Messages</a>
                            </li>
                            <li><a href="#3a" data-toggle="tab">Logs</a>
                            </li>
                        </ul>

                        <div class="tab-content clearfix">
                            <div class="tab-pane active" id="1a">
                                <div class="panel panel-info" id="receive_tab">
                                    <div class="panel-heading">
                                        <h4 class="panel-title">
                                            <a data-toggle="collapse" data-parent="#accordion"
                                               href="#received_messages">
                                                Received Message
                                                <span class="glyphicon glyphicon-chevron-down"></span>
                                            </a>
                                        </h4>
                                    </div>
                                    <div id="received_messages" class="panel-collapse collapse">
                                        <div class="panel-body">
                                            <div class="panel-group" id="rlist" data-click="clickchange">
                                                <!--                            ONly for by pass js error-->
                                                <div class="panel panel-default" hidden>
                                                    <header class="panel-heading">
                                                        <h4 class="panel-title">
                                                            <a data-toggle="collapse" data-parent="#rlist"
                                                               href="#insideOne">
                                                            </a>
                                                        </h4>
                                                    </header>
                                                </div>

                                            </div>
                                        </div>
                                    </div>


                                </div>
                            </div>
                            <div class="tab-pane" id="2a">
                                <div class="panel panel-info" id="send_tab">
                                    <div class="panel-heading">
                                        <h4 class="panel-title">
                                            <a data-toggle="collapse" data-parent="#accordion" href="#sent_messages">
                                                Sent Messages
                                                <span class="glyphicon glyphicon-chevron-down"></span>
                                            </a>
                                        </h4>
                                    </div>
                                    <div id="sent_messages" class="panel-collapse collapse">
                                        <div class="panel-body">
                                            <div class="panel-group" id="slist" data-click="clickchange">
                                                <!--                            ONly for by pass js error-->
                                                <div class="panel panel-default" hidden>
                                                    <header class="panel-heading">
                                                        <h4 class="panel-title">
                                                            <a data-toggle="collapse" data-parent="#slist"
                                                               href="#insideOne1">
                                                            </a>
                                                        </h4>
                                                    </header>
                                                    <div id="insideOne1" class="panel-collapse collapse">
                                                        <article class="panel-body">
                                                            This sort of structure is useful for categorising FAQs. I'm
                                                            sure
                                                            there are many other uses as well.
                                                        </article>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane" id="3a">
                                <div class="panel panel-info" id="log_tab">
                                    <div class="panel-heading">
                                        <h4 class="panel-title">
                                            <a data-toggle="collapse" data-parent="#accordion" href="#log_messages">
                                                Log Message
                                                <span class="glyphicon glyphicon-chevron-down"></span>
                                            </a>
                                        </h4>
                                    </div>
                                    <div id="log_messages" class="panel-collapse collapse">
                                        <div class="panel-body">
                                            <div class="panel-group" id="llist" data-click="clickchange">
                                                <!--                            ONly for by pass js error-->
                                                <div class="panel panel-default" hidden>
                                                    <header class="panel-heading">
                                                        <h4 class="panel-title">
                                                            <a data-toggle="collapse" data-parent="#llist"
                                                               href="#insideOne2">
                                                            </a>
                                                        </h4>
                                                    </header>
                                                    <div id="insideOne2" class="panel-collapse collapse">
                                                        <article class="panel-body">
                                                            This sort of structure is useful for categorising FAQs. I'm
                                                            sure
                                                            there are many other uses as well.
                                                        </article>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane" id="4a">
                                <h3>We use css to change the background color of the content to be equal to the tab</h3>
                            </div>
                        </div>
                    </div>

                </article>
            </section>


            <footer>
                <h3></h3>

            </footer>
        </div>
    </div>
</div>

<script src="dist/js/jquery.js"></script>
<script type="text/javascript" src="dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="dist/js/bootstrap-collapse-clickchange.js"></script>
<script type="text/javascript" src="cloud_xml.js"></script>
<script type="text/javascript" src="xml2json.js"></script>
<script type="text/javascript">
    function parseXmlToJson(xml) {
        xml = xml.replaceAll('\n', '')
        var x2js = new X2JS();
        var ret = x2js.xml_str2json(xml)
        if (ret) return ret;


        const json = {};
        try {
            for (const res of xml.matchAll(/(?:<(\w*)(?:\s[^>]*)*>)((?:(?!<\1).)*)(?:<\/\1>)|<(\w*)(?:\s*)*\/>/gm)) {
                const key = res[1] || res[3];
                const value = res[2] && parseXmlToJson(res[2]);
                json[key] = ((value && Object.keys(value).length) ? value : res[2]) || null;
            }
        } catch (e) {
            return e.message;
        }
        console.log("-> json", json);
        return json;
        // return xml2json.fromStr(xml)
    }

    $(document).ready(function () {
        async function read(input) {
            msg.innerText = await readFile(input.files[0]);
        }

        $('#listen').click(function () {
            if ($(this).text().trim() == 'Listen') {
                $(this).text('Stop');
                listenFromSocket();
            } else {
                $(this).text('Listen');
                var socket = new WebSocket('ws://localhost:8000');
                socket.addEventListener('open', function (event) {
                    socket.send("stop");
                })
            }
        });

        $(document).on('click', '#send', function (e) {

            sendToSocket();
        });

        function readFile(file) {
            return new Promise((resolve, reject) => {
                let fr = new FileReader();
                fr.onload = x => resolve(fr.result);
                fr.readAsText(file);
            })
        }
    });
</script>
<script>
    // $('#listen').clickChange({
    //     when: 'before',
    //     parentclass: 'btn-primary btn-success',
    //     iconchange: true,
    //     iconprefixadd: false,
    //     iconprefix: 'toggleonclick',
    //     iconclass: 'hidden'
    // });

    function getWsMessage(info, type, message) {
        return `{"info": "${info}", "log":"${type}", "data": "${message}"}`;
    }

    function getItem(x) {
        console.log("-> jsondata: ", x.trim());
        json_package = JSON.parse(x)
        let info = json_package.info;
        let message = json_package.data;
        message = message.replaceAll("<", "&lt;").replaceAll(">", "&gt;")
        tag_id = Math.random().toString(36).slice(2)
        var newDate = new Date();
        current_time = newDate.toISOString();

        var item = `<div class="panel panel-default">
                                            <header class="panel-heading">
                                                <h4 class="panel-title">
                                                    <a data-toggle="collapse" data-parent="#inside-accordion"
                                                       href="#${tag_id}">
                                                        <span class="glyphicon glyphicon-comment"></span>
                                                        ${current_time}
                                                        <span class="glyphicon glyphicon-chevron-down"></span>
                                                    </a>
                                                </h4>
                                            </header>
                                            <div id="${tag_id}" class="panel-collapse collapse">
                                                <article class="panel-body">
                                                                   <div class="content">
                                                   <div class="row">
                                                       <div class="col-lg-2">
                                                           <p>
                                                           <h3>Packet Info:</h3></p>
                                                           <p>${info}</p>
                                                       </div>
                                                       <div class="col-lg-5">
                                                           <p>
                                                           <h3>Message:</h3></p>
                                                           <p>${message}</p>
                                                       </div>
                                                       <div class="col-lg-5">
                                                           <p>
                                                           <h3>XML Parser:</h3></p>
                                                           <pre id="parsed">${JSON.stringify(parseXmlToJson(json_package.data), undefined, 2)}</pre>
                                                       </div>

                                                   </div>

                                                </article>
                                            </div>
                                        </div>`
        return item;
    }


    function listenFromSocket() {
        port = document.getElementById("port").value;
        socket = new WebSocket('ws://localhost:8000');
        socket.addEventListener('open', function (event) {
            socket.send(JSON.stringify({"type": "config", "data": {"ip": "", "port": port}}));
        });
        socket.addEventListener('message', function (event) {
            console.log('recv: ' + event.data)
            try {
                jsonMessage = JSON.parse(event.data)
                var item = getItem(event.data);
                if(jsonMessage['type']=="message")
                    $('#rlist').prepend(item);
                else
                    $('#llist').prepend(item);

            } catch (e) {
                console.log(e)
                var item = getItem(getWsMessage("server", "system", event.data));
                $('#llist').prepend(item);
            }

        });
        const contactServer = () => {

            socket.send("Initialize");

        }
    }

    function escapeNewLineChars(valueToEscape) {
        if (valueToEscape != null && valueToEscape != "") {
            valueToEscape = valueToEscape.replaceAll('"', '\\"');
            return valueToEscape.replaceAll(/\n/g, " ");
        } else {
            return valueToEscape;
        }
    }

    function sendToSocket() {
        var data = $('select').find('option:selected').val();
        var socket = new WebSocket('ws://localhost:8000');
        socket.addEventListener('open', function (event) {
            let wsData = (xml_data[data]);
            wsData = escapeNewLineChars(wsData)
            console.log(wsData)
            socket.send(wsData)
            displayData = getWsMessage("send", "message", wsData)
            // console.log("-> displayData", displayData);
            tag_id = "send_msg_" + Math.random().toString(36).slice(2)
            var item = getItem(displayData);
            // console.log(item)
            $('#slist').prepend(item);
        });

    }

</script>
</body>
</html>